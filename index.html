<!DOCTYPE html>
<html>
	<head>
	    <title>Zeldus - test</title>
	    <!-- Bootstrap Latest compiled and minified CSS -->
		<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
		<!-- Require -->
		<script type="text/javascript" src="zeldus.js"></script>

		<style type="text/css">
			textarea { width: 100%; height: 200px; }
			.marginTop { margin-top: 20px; }
		</style>
	</head>
	<body>
		<div class="row">
			<div class="col-md-6 col-md-offset-3">
				<h1>Zeldus</h1>
				<h4><em>A JavaScript column oriented database</em></h4>
				Enter a query
			</div>
		</div>
		<div class="row">
			<div class="col-md-2 col-md-offset-1">
				<h4>Example queries</h4>
				<pre>select shipdate </br>from lineitem</pre>
				<pre>select shipdate, linenumber </br>from lineitem</pre>
				<pre>select shipdate </br>from lineitem </br>where shipdate > 19940101</pre>
				<pre>select linenumber </br>from lineitem </br>where shipdate > 19940101</pre>
				<pre>select linenumber, shipmode </br>from lineitem </br>where supplierkey = 777 </br>and shipdate > 19940101</pre>
				<em>...and many more!</em>
				<h4>Table: lineitem</h4>
				<ul>
					<li>orderkey (int)</li>
					<li>partkey (int)</li>
					<li>supplierkey (int)</li>
					<li>linenumber (int)</li>
					<li>quantity (decimal)</li>
					<li>extendedprice (decimal)</li>
					<li>discount (decimal)</li>
					<li>tax (decimal)</li>
					<li>returnflag (string)</li>
					<li>linestatus (string)</li>
					<li>shipdate (int)</li>
					<li>commitdate (int)</li>
					<li>receiptdate (int)</li>
					<li>shipinstruct (string)</li>
					<li>shipmode (string)</li>
					<li>comment (string)</li>
				</ul>
			</div>
			<div class="col-md-6">
				<textarea id="sqlquery">
select shipdate from lineitem
				</textarea>
				<button type="submit" class="btn btn-danger" onclick="execute()">Execute</button>
				<div id="queryResultsMetadata" class="marginTop"></div>
				<div id="queryResults" class="marginTop"></div>
			</div>
		</div>
		<script type="text/javascript">
			var queryResults = document.getElementById('queryResults'),
				queryResultsMetadata = document.getElementById('queryResultsMetadata');

			//~~ Zeldus ~~
			var db = null;
			require.config({
		    	baseUrl: "src"
		  	});
			require(['zeldus', 'utils/DSLoader'], function(Zeldus, DSLoader) {
			    db = new Zeldus({
			    	dataSource: [ new DSLoader('lineitem', 'data/lineitem.json') ]
			    });
			    db.createProjection('p1_shipdate_suppkey', '(L_SHIPDATE, L_SUPPKEY, L_SHIPMODE, L_EXTENDEDPRICE | L_SHIPDATE, L_SUPPKEY)');
			});

			function execute(){
				if(db != null){
					var sqlquery = document.getElementById('sqlquery');
					if(sqlquery.value != null && sqlquery.value.length > 0){
						//start timer
						var queryStart = new Date();
						db.execute(sqlquery.value, function(results){
							var queryEnd = new Date();
							var resultsTable = '';
							var limit = results.length < 100 ? results.length : 100;
							for(var i = 0; i < limit; i++){
								//table header
								if(i == 0){
									resultsTable += '<tr>';
									for(var c in results[i]){
										resultsTable += '<th>' + c + '</th>';
									}
									resultsTable += '</tr>';
								}
								//contents
								resultsTable += '<tr>';
								for(var c in results[i]){
									resultsTable += '<td>' + results[i][c] + '</td>';
								}
								resultsTable += '</tr>';
							}
							queryResultsMetadata.innerHTML = 'Execution: ' + results.length + ' records in ' + ((queryEnd - queryStart) / 1000) + ' seconds'
							queryResults.innerHTML = '<table class="table">' + resultsTable + '</table>';
						});
					}else{
						//log
					}
				}
			}
		</script>		
	</body>
</html>